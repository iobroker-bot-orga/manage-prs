name: Process LATEST repositories

on:
  repository_dispatch:
    types: [process-latest-restart]

  workflow_dispatch:
    inputs:
      template:
        type: string
        required: true
        description: 'Name of the template to apply'

      filter:
        type: string
        required: false
        description: 'Filter repositories by owner/name pattern (optional). Supports wildcards: owner/*, */name, owner*/*, */*pattern*. Case-insensitive.'

      pr_mode:
        description: 'PR mode for handling existing PRs'
        required: false
        type: choice
        default: 'recreate'
        options:
          - 'force creation'
          - 'recreate'
          - 'skip if existing'
          - 'skip if closed'
          - 'skip if merged'
          - 'REVOKE'

      parameter_data:
        type: string
        required: false
        description: 'Optional parameter data to pass to the template'

      flags:
        type: string
        required: false
        description: 'Optional flags to pass to the worflow'

      from:
        type: string
        required: false
        description: 'Resume processing from this adapter name (optional)'

  #schedule:
    # * is a special character in YAML, so you have to quote this string
    # every friday at 1:00
    # - cron:  '15 0 * * 5'

jobs:
  process-latest-repositories:
    name: process latest repositories
    if: |
      github.repository == 'iobroker-bot-orga/manage-prs'
      
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 20
      - run: npm install
      
      - name: Trim workflow parameters
        id: trim_params
        run: |
          # Trim all string input parameters to remove leading/trailing whitespace
          # Handle both workflow_dispatch (inputs) and repository_dispatch (client_payload)
          TEMPLATE=$(echo "${{ github.event.inputs.template }}${{ github.event.client_payload.template }}" | xargs)
          PARAM_DATA=$(echo "${{ github.event.inputs.parameter_data }}${{ github.event.client_payload.parameter_data }}" | xargs)
          PR_MODE=$(echo "${{ github.event.inputs.pr_mode }}${{ github.event.client_payload.pr_mode }}" | xargs)
          FROM=$(echo "${{ github.event.inputs.from }}${{ github.event.client_payload.from }}" | xargs)
          FILTER=$(echo "${{ github.event.inputs.filter }}${{ github.event.client_payload.filter }}" | xargs)
          FLAGS=$(echo "${{ github.event.inputs.flags }}${{ github.event.client_payload.flags }}" | xargs)
          
          echo "template=$TEMPLATE" >> $GITHUB_OUTPUT
          echo "parameter_data=$PARAM_DATA" >> $GITHUB_OUTPUT
          echo "pr_mode=$PR_MODE" >> $GITHUB_OUTPUT
          echo "from=$FROM" >> $GITHUB_OUTPUT
          echo "filter=$FILTER" >> $GITHUB_OUTPUT
          echo "flags=$FLAGS" >> $GITHUB_OUTPUT
      
      - name: Run processLatestRepositories.js
        run: node ./processLatestRepositories.js --template="${{ steps.trim_params.outputs.template }}" --parameter_data="${{ steps.trim_params.outputs.parameter_data }}" --pr_mode="${{ steps.trim_params.outputs.pr_mode }}" --from="${{ steps.trim_params.outputs.from }}" --filter="${{ steps.trim_params.outputs.filter }}" ${{ steps.trim_params.outputs.flags }}
        env:
          GH_TOKEN: ${{ secrets.IOBBOT_GITHUB_TOKEN_WITH_WF }}
