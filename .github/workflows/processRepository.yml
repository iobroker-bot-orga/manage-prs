name: processRepository
run-name: process repository (${{ inputs.template }} for ${{ inputs.repository_url }})

on:
  workflow_dispatch:
    inputs:
      repository_url:
        description: 'GitHub repository (formats: "owner/repo", "https://github.com/owner/repo", or "git@github.com:owner/repo")'
        required: true
        type: string
      template:
        description: 'Name of the template'
        required: true
        type: string
      parameter_data:
        description: 'Optional parameter data to pass to the template'
        required: false
        type: string
      pr_mode:
        description: 'PR mode for handling existing PRs'
        required: false
        type: choice
        default: 'recreate'
        options:
          - 'force creation'
          - 'recreate'
          - 'skip if existing'
          - 'skip if closed'
          - 'skip if merged'
          - 'REVOKE'

jobs:
  process-repository:
    runs-on: ubuntu-latest
    steps:
      - name: Log workflow parameters
        run: |
          echo "==================================================================="
          echo "Workflow Parameters:"
          echo "==================================================================="
          echo "Repository URL: ${{ inputs.repository_url }}"
          echo "Template: ${{ inputs.template }}"
          echo "Parameter Data: ${{ inputs.parameter_data }}"
          echo "PR Mode: ${{ inputs.pr_mode }}"
          echo "==================================================================="

      - name: Checkout this repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      - run: |
          echo "Node version: $(node --version)"
          echo "NPM version: $(npm --version)"

      - name: Install dependencies
        run: npm i

      - name: Extract repository info
        id: repo_info
        run: |
          # Extract owner and repo name from input (handles both URL and owner/repo formats)
          REPO_INPUT="${{ inputs.repository_url }}"
          # Remove trailing .git if present
          REPO_INPUT="${REPO_INPUT%.git}"
          
          # Check if input is a full URL or just owner/repo
          if [[ $REPO_INPUT =~ github.com[:/]([^/]+)/([^/]+)$ ]]; then
            # Full URL format (https or git@)
            OWNER="${BASH_REMATCH[1]}"
            REPO="${BASH_REMATCH[2]}"
            FULL_URL="https://github.com/$OWNER/$REPO"
          elif [[ $REPO_INPUT =~ ^([^/]+)/([^/]+)$ ]]; then
            # owner/repo format
            OWNER="${BASH_REMATCH[1]}"
            REPO="${BASH_REMATCH[2]}"
            FULL_URL="https://github.com/$OWNER/$REPO"
          else
            echo "Error: Invalid repository format. Use 'owner/repo', 'https://github.com/owner/repo', or 'git@github.com:owner/repo'"
            exit 1
          fi
          
          echo "owner=$OWNER" >> $GITHUB_OUTPUT
          echo "repo=$REPO" >> $GITHUB_OUTPUT
          echo "full_name=$OWNER/$REPO" >> $GITHUB_OUTPUT
          echo "full_url=$FULL_URL" >> $GITHUB_OUTPUT
          echo ">>> Extracted repository info:"
          echo "    Owner: $OWNER"
          echo "    Repo: $REPO"
          echo "    Full name: $OWNER/$REPO"
          echo "    Full URL: $FULL_URL"

      - name: Fork repository
        env:
          GH_TOKEN: ${{ secrets.IOBBOT_GITHUB_TOKEN_WITH_WF }}
        run: |
          echo ">>> Starting: Fork repository"
          # Get the authenticated user
          CURRENT_USER=$(gh api user -q .login)
          echo "    Current user: $CURRENT_USER"

          # Check if fork already exists
          echo "    Checking if fork exists at $CURRENT_USER/${{ steps.repo_info.outputs.repo }}"
          if gh repo view "$CURRENT_USER/${{ steps.repo_info.outputs.repo }}" >/dev/null 2>&1; then
            echo "    Fork already exists"

            # Verify that the fork is based on the target repository
            echo "    Verifying fork parent..."
            FORK_PARENT=$(gh repo view "$CURRENT_USER/${{ steps.repo_info.outputs.repo }}" --json parent -q 'if .parent then "\(.parent.owner.login)/\(.parent.name)" else "" end')
            if [ -z "$FORK_PARENT" ]; then
              echo "    ERROR: Repository exists but is not a fork"
              echo "    Repository: $CURRENT_USER/${{ steps.repo_info.outputs.repo }}"
              exit 1
            fi
            # Compare case-insensitively since GitHub URLs are case-insensitive
            FORK_PARENT_LOWER=$(echo "$FORK_PARENT" | tr '[:upper:]' '[:lower:]')
            EXPECTED_PARENT_LOWER=$(echo "${{ steps.repo_info.outputs.full_name }}" | tr '[:upper:]' '[:lower:]')
            if [ "$FORK_PARENT_LOWER" != "$EXPECTED_PARENT_LOWER" ]; then
              echo "    ERROR: Fork exists but is not based on ${{ steps.repo_info.outputs.full_name }}"
              echo "    Fork parent: $FORK_PARENT"
              echo "    Expected: ${{ steps.repo_info.outputs.full_name }}"
              exit 1
            fi
            echo "    Fork parent verified: $FORK_PARENT"

            # Sync fork with upstream
            echo "    Syncing fork with upstream repository..."
            gh repo sync "$CURRENT_USER/${{ steps.repo_info.outputs.repo }}" --source "${{ steps.repo_info.outputs.full_name }}" || echo "    Fork sync completed or already up to date"
            echo "    Fork is up to date with upstream"
          else
            # Fork the repository
            echo "    Creating new fork..."
            gh repo fork ${{ steps.repo_info.outputs.full_name }} --clone=false || echo "    Fork creation may have encountered an issue"
            echo "    Fork created successfully"
          fi
          echo ">>> Completed: Fork repository"

      - name: Clone target repository
        env:
          GH_TOKEN: ${{ secrets.IOBBOT_GITHUB_TOKEN_WITH_WF }}
        run: |
          echo ">>> Starting: Clone target repository"
          # Get the authenticated user for fork remote
          CURRENT_USER=$(gh api user -q .login)
          echo "    Current user: $CURRENT_USER"

          # Clone the repository
          echo "    Cloning from: ${{ steps.repo_info.outputs.full_url }}.git"
          git clone ${{ steps.repo_info.outputs.full_url }}.git target-repo
          cd target-repo
          echo "    Configuring git user..."
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          # Add fork as a remote with authentication
          echo "    Adding fork remote..."
          git remote add fork https://x-access-token:${GH_TOKEN}@github.com/${CURRENT_USER}/${{ steps.repo_info.outputs.repo }}.git
          echo "    Fork remote added: ${CURRENT_USER}/${{ steps.repo_info.outputs.repo }}"

          echo "    Current directory: $(pwd)"
          echo "    Git remotes:"
          git remote -v
          echo "    Git status:"
          git status
          echo ">>> Completed: Clone target repository"

      - name: Create branch
        run: |
          echo ">>> Starting: Create branch"
          cd target-repo
          
          # Detect the default branch
          DEFAULT_BRANCH=$(git symbolic-ref refs/remotes/origin/HEAD | sed 's@^refs/remotes/origin/@@')
          echo "    Detected default branch: $DEFAULT_BRANCH"
          echo "default_branch=$DEFAULT_BRANCH" >> $GITHUB_ENV
          
          BRANCH_NAME="update-from-template-${{ inputs.template }}-$(date +%s)"
          echo "    Creating branch: $BRANCH_NAME"
          git checkout -b $BRANCH_NAME
          echo "branch_name=$BRANCH_NAME" >> $GITHUB_ENV
          echo "==================================================================="
          echo "Default Branch: $DEFAULT_BRANCH"
          echo "Branch Name: $BRANCH_NAME"
          echo "==================================================================="
          echo ">>> Completed: Create branch"

      - name: Run prGenerator.js script
        run: |
          echo ">>> Starting: Run prGenerator.js script"
          cd target-repo
          echo "    Executing: node ../prGenerator.js \"${{ steps.repo_info.outputs.full_name }}\" \"${{ inputs.template }}\" \"${{ inputs.parameter_data }}\""
          node ../prGenerator.js "${{ steps.repo_info.outputs.full_name }}" "${{ inputs.template }}" "${{ inputs.parameter_data }}"
          echo ">>> Completed: Run prGenerator.js script"

      - name: Commit and push changes
        env:
          GH_TOKEN: ${{ secrets.IOBBOT_GITHUB_TOKEN_WITH_WF }}
        run: |
          echo ">>> Starting: Commit and push changes"
          cd target-repo
          echo "    Staging all changes..."
          git add -v . :!./.iobroker-pr-body.tmp :!./.iobroker-pr-title.tmp
          echo "    Checking for staged changes..."
          if git diff --staged --quiet; then
            echo "    No changes to commit"
            echo "has_changes=false" >> $GITHUB_ENV
          else
            echo "    Changes detected, committing..."
            git commit -m "Update from template: ${{ inputs.template }}"
            echo "    Pushing to fork remote, branch: ${{ env.branch_name }}"
            git push fork ${{ env.branch_name }}
            echo "    Changes pushed successfully"
            echo "has_changes=true" >> $GITHUB_ENV
          fi
          echo ">>> Completed: Commit and push changes"

      - name: Manage Pull Request(s)
        env:
          GH_TOKEN: ${{ secrets.IOBBOT_GITHUB_TOKEN_WITH_WF }}
        run: |
          echo ">>> Starting: Pull Request Management"
          
          # Skip PR creation if there are no changes
          if [ "${{ env.has_changes }}" = "false" ]; then
            echo "    Skipping PR creation - no changes were made"
            echo ">>> Completed: Create Pull Request"
            echo "==================================================================="
            echo "Workflow completed successfully (no changes)"
            echo "==================================================================="
            exit 0
          fi
          
          cd target-repo
          # Get the authenticated user for fork reference
          CURRENT_USER=$(gh api user -q .login)
          
          # Verify PR metadata files exist
          if [ ! -f .iobroker-pr-title.tmp ]; then
            echo "    Creating default PR title..."
            echo "Update from template: ${{ inputs.template }}" > .iobroker-pr-title.tmp
          fi
          
          if [ ! -f .iobroker-pr-body.tmp ]; then
            echo "    Creating default PR body..."
            echo "This PR applies changes from template: ${{ inputs.template }}" > .iobroker-pr-body.tmp
          fi
          
          # Display PR details
          PR_TITLE=$(cat .iobroker-pr-title.tmp)
          echo "    PR Details:"
          echo "      Title: $PR_TITLE"
          echo "      Base: ${{ env.default_branch }}"
          echo "      Head: ${CURRENT_USER}:${{ env.branch_name }}"
          echo "      Repository: ${{ steps.repo_info.outputs.full_name }}"
          echo "      Mode: ${{ inputs.pr_mode }}"
          
          # Use prManager.js to handle PR creation based on mode
          node ../prManager.js "${{ inputs.pr_mode }}" "${{ steps.repo_info.outputs.full_name }}" "${{ env.default_branch }}" "${CURRENT_USER}:${{ env.branch_name }}"
          
          echo ">>> Completed: Pull Request Management"
          echo "==================================================================="
          echo "Workflow completed successfully"
          echo "==================================================================="
